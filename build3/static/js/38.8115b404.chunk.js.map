{"version":3,"file":"static/js/38.8115b404.chunk.js","mappings":"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","sources":["pages/PaymentCallback.js"],"sourcesContent":["import React, { useEffect, useMemo, useState } from 'react';\nimport { useSearchParams, useNavigate } from 'react-router-dom';\nimport { useAuth } from '../contexts/AuthContext';\nimport { getApiUrl } from '../utils/apiConfig';\nimport LoadingSpinner from '../components/LoadingSpinner';\n\nconst CALLBACK_STORAGE_KEY = 'propertyVerificationPayments';\n\nconst readStoredPayments = () => {\n  if (typeof window === 'undefined') return [];\n  try {\n    const raw = localStorage.getItem(CALLBACK_STORAGE_KEY);\n    return raw ? JSON.parse(raw) : [];\n  } catch (error) {\n    console.warn('PaymentCallback: unable to read stored payments', error);\n    return [];\n  }\n};\n\nconst writeStoredPayments = (entries) => {\n  if (typeof window === 'undefined') return;\n  try {\n    localStorage.setItem(CALLBACK_STORAGE_KEY, JSON.stringify(entries));\n  } catch (error) {\n    console.warn('PaymentCallback: unable to write stored payments', error);\n  }\n};\n\nconst PaymentCallback = () => {\n  const { user } = useAuth();\n  const [searchParams] = useSearchParams();\n  const navigate = useNavigate();\n  const [status, setStatus] = useState('processing');\n  const [message, setMessage] = useState('Processing payment confirmation...');\n  const [details, setDetails] = useState('Hold on while we confirm your payment status.');\n\n  const callbackInfo = useMemo(() => ({\n    status: searchParams.get('status'),\n    txRef: searchParams.get('tx_ref') || searchParams.get('txRef'),\n    transactionId: searchParams.get('transaction_id') || searchParams.get('transactionId'),\n    processor: searchParams.get('processor')\n  }), [searchParams]);\n\n  useEffect(() => {\n    const { txRef, status: paymentStatus } = callbackInfo;\n\n    if (!txRef) {\n      setStatus('error');\n      setMessage('Missing payment reference');\n      setDetails('Unable to determine which payment to verify.');\n      return;\n    }\n\n    const storedEntries = readStoredPayments();\n    const entry = storedEntries.find((item) => item.txRef === txRef || item.reference === txRef);\n\n    if (!entry) {\n      setStatus('error');\n      setMessage('Payment reference not found');\n      setDetails('Please return to the verification form and start the payment again.');\n      return;\n    }\n\n    verifyPayment(entry, paymentStatus, storedEntries);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [callbackInfo]);\n\n  const buildHeaders = () => {\n    const token = user?.token || (() => {\n      try {\n        return localStorage.getItem('token');\n      } catch {\n        return null;\n      }\n    })();\n\n    const fallbackEmail = user?.email;\n\n    if (!token && !fallbackEmail) {\n      return null;\n    }\n\n    const headers = {\n      'Content-Type': 'application/json'\n    };\n\n    if (token) {\n      headers.Authorization = `Bearer ${token}`;\n    } else if (fallbackEmail) {\n      headers['X-Mock-User-Email'] = fallbackEmail;\n    }\n\n    return headers;\n  };\n\n  const verifyPayment = async (entry, paymentStatus, storedEntries) => {\n    const headers = buildHeaders();\n\n    if (!headers) {\n      setStatus('error');\n      setMessage('Sign in required');\n      setDetails('Please log in again to complete verification.');\n      return;\n    }\n\n    try {\n      setStatus('verifying');\n      setMessage('Verifying payment...');\n      setDetails('Hold on while we confirm your payment status.');\n\n      const response = await fetch(getApiUrl(`/payments/${entry.paymentId}/verify`), {\n        method: 'POST',\n        headers,\n        body: JSON.stringify({ txRef: entry.txRef, status: paymentStatus })\n      });\n\n      const data = await response.json();\n      if (!response.ok || !data.success) {\n        throw new Error(data.message || 'Payment verification failed');\n      }\n\n      if (data.data?.status !== 'completed') {\n        setStatus('pending');\n        setMessage('Payment still processing');\n        setDetails('We have not received confirmation from Flutterwave yet. Please try again shortly.');\n        return;\n      }\n\n      const updatedEntries = storedEntries.map((item) =>\n        item.paymentId === entry.paymentId\n          ? {\n              ...item,\n              verified: true,\n              verificationPaymentId: data.data.id\n            }\n          : item\n      );\n      writeStoredPayments(updatedEntries);\n\n      const messagePayload = {\n        type: 'PROPERTY_VERIFICATION_PAYMENT',\n        payload: {\n          paymentId: entry.paymentId,\n          verificationPaymentId: data.data.id,\n          status: 'success'\n        }\n      };\n\n      if (window.opener && !window.opener.closed) {\n        window.opener.postMessage(messagePayload, '*');\n      }\n\n      if (window.parent && window.parent !== window) {\n        window.parent.postMessage(messagePayload, '*');\n      }\n\n      setStatus('success');\n      setMessage('Payment verified successfully');\n      setDetails('You can now return to the verification request modal to finish submission.');\n\n      setTimeout(() => {\n        window.close();\n        if (entry.propertyId) {\n          navigate(`/property/${entry.propertyId}?verification=completed`, { replace: true });\n        }\n      }, 1500);\n    } catch (error) {\n      console.error('PaymentCallback: verification error', error);\n      setStatus('error');\n      setMessage('Unable to verify payment');\n      setDetails(error?.message || 'Please try again from the verification page.');\n\n      const messagePayload = {\n        type: 'PROPERTY_VERIFICATION_PAYMENT',\n        payload: {\n          paymentId: entry?.paymentId,\n          status: 'error',\n          message: error?.message || 'Verification failed'\n        }\n      };\n\n      if (window.opener && !window.opener.closed) {\n        window.opener.postMessage(messagePayload, '*');\n      }\n\n      if (window.parent && window.parent !== window) {\n        window.parent.postMessage(messagePayload, '*');\n      }\n    }\n  };\n\n  const StatusIcon = () => {\n    switch (status) {\n      case 'success':\n        return <span className=\"text-green-600 text-4xl\">✔</span>;\n      case 'error':\n        return <span className=\"text-red-500 text-4xl\">✖</span>;\n      case 'pending':\n        return <span className=\"text-amber-500 text-4xl\">⏳</span>;\n      default:\n        return <LoadingSpinner size=\"lg\" />;\n    }\n  };\n\n  return (\n    <div className=\"max-w-2xl mx-auto px-6 py-16\">\n      <div className=\"bg-white shadow-lg rounded-2xl p-8 text-center space-y-4\">\n        <div className=\"mx-auto w-16 h-16 flex items-center justify-center rounded-full bg-gray-100\">\n          <StatusIcon />\n        </div>\n        <h1 className=\"text-2xl font-semibold text-gray-900\">Flutterwave Payment Callback</h1>\n        <p className=\"text-gray-600\">{message}</p>\n        {details && <p className=\"text-sm text-gray-500\">{details}</p>}\n        {callbackInfo.txRef && (\n          <div className=\"text-xs text-gray-400\">Reference: {callbackInfo.txRef}</div>\n        )}\n        <div className=\"pt-4\">\n          <button\n            type=\"button\"\n            onClick={() => navigate(-1)}\n            className=\"px-4 py-2 text-sm font-medium text-blue-600 hover:underline\"\n          >\n            Go back\n          </button>\n        </div>\n      </div>\n    </div>\n  );\n};\n\nexport default PaymentCallback;\n"],"names":["CALLBACK_STORAGE_KEY","PaymentCallback","user","useAuth","searchParams","useSearchParams","navigate","useNavigate","status","setStatus","useState","message","setMessage","details","setDetails","callbackInfo","useMemo","get","txRef","transactionId","processor","useEffect","paymentStatus","storedEntries","readStoredPayments","window","raw","localStorage","getItem","JSON","parse","error","console","warn","entry","find","item","reference","verifyPayment","async","headers","buildHeaders","token","fallbackEmail","email","Authorization","_data$data","response","fetch","getApiUrl","paymentId","method","body","stringify","data","json","ok","success","Error","entries","setItem","writeStoredPayments","map","verified","verificationPaymentId","id","messagePayload","type","payload","opener","closed","postMessage","parent","setTimeout","close","propertyId","replace","StatusIcon","_jsx","className","children","LoadingSpinner","size","_jsxs","onClick"],"sourceRoot":""}