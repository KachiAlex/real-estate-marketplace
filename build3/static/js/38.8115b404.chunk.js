"use strict";(self.webpackChunkreal_estate_marketplace=self.webpackChunkreal_estate_marketplace||[]).push([[38],{38:(e,t,n)=>{n.r(t),n.d(t,{default:()=>p});var a=n(5043),r=n(5475),s=n(3216),o=n(5016),i=n(1876),c=n(9144),l=n(579);const d="propertyVerificationPayments",p=()=>{const{user:e}=(0,o.As)(),[t]=(0,r.ok)(),n=(0,s.Zp)(),[p,m]=(0,a.useState)("processing"),[u,f]=(0,a.useState)("Processing payment confirmation..."),[y,w]=(0,a.useState)("Hold on while we confirm your payment status."),x=(0,a.useMemo)(()=>({status:t.get("status"),txRef:t.get("tx_ref")||t.get("txRef"),transactionId:t.get("transaction_id")||t.get("transactionId"),processor:t.get("processor")}),[t]);(0,a.useEffect)(()=>{const{txRef:e,status:t}=x;if(!e)return m("error"),f("Missing payment reference"),void w("Unable to determine which payment to verify.");const n=(()=>{if("undefined"===typeof window)return[];try{const e=localStorage.getItem(d);return e?JSON.parse(e):[]}catch(e){return console.warn("PaymentCallback: unable to read stored payments",e),[]}})(),a=n.find(t=>t.txRef===e||t.reference===e);if(!a)return m("error"),f("Payment reference not found"),void w("Please return to the verification form and start the payment again.");g(a,t,n)},[x]);const g=async(t,a,r)=>{const s=(()=>{const t=(null===e||void 0===e?void 0:e.token)||(()=>{try{return localStorage.getItem("token")}catch{return null}})(),n=null===e||void 0===e?void 0:e.email;if(!t&&!n)return null;const a={"Content-Type":"application/json"};return t?a.Authorization=`Bearer ${t}`:n&&(a["X-Mock-User-Email"]=n),a})();if(!s)return m("error"),f("Sign in required"),void w("Please log in again to complete verification.");try{var o;m("verifying"),f("Verifying payment..."),w("Hold on while we confirm your payment status.");const e=await fetch((0,i.e9)(`/payments/${t.paymentId}/verify`),{method:"POST",headers:s,body:JSON.stringify({txRef:t.txRef,status:a})}),c=await e.json();if(!e.ok||!c.success)throw new Error(c.message||"Payment verification failed");if("completed"!==(null===(o=c.data)||void 0===o?void 0:o.status))return m("pending"),f("Payment still processing"),void w("We have not received confirmation from Flutterwave yet. Please try again shortly.");(e=>{if("undefined"!==typeof window)try{localStorage.setItem(d,JSON.stringify(e))}catch(t){console.warn("PaymentCallback: unable to write stored payments",t)}})(r.map(e=>e.paymentId===t.paymentId?{...e,verified:!0,verificationPaymentId:c.data.id}:e));const l={type:"PROPERTY_VERIFICATION_PAYMENT",payload:{paymentId:t.paymentId,verificationPaymentId:c.data.id,status:"success"}};window.opener&&!window.opener.closed&&window.opener.postMessage(l,"*"),window.parent&&window.parent!==window&&window.parent.postMessage(l,"*"),m("success"),f("Payment verified successfully"),w("You can now return to the verification request modal to finish submission."),setTimeout(()=>{window.close(),t.propertyId&&n(`/property/${t.propertyId}?verification=completed`,{replace:!0})},1500)}catch(c){console.error("PaymentCallback: verification error",c),m("error"),f("Unable to verify payment"),w((null===c||void 0===c?void 0:c.message)||"Please try again from the verification page.");const e={type:"PROPERTY_VERIFICATION_PAYMENT",payload:{paymentId:null===t||void 0===t?void 0:t.paymentId,status:"error",message:(null===c||void 0===c?void 0:c.message)||"Verification failed"}};window.opener&&!window.opener.closed&&window.opener.postMessage(e,"*"),window.parent&&window.parent!==window&&window.parent.postMessage(e,"*")}},v=()=>{switch(p){case"success":return(0,l.jsx)("span",{className:"text-green-600 text-4xl",children:"\u2714"});case"error":return(0,l.jsx)("span",{className:"text-red-500 text-4xl",children:"\u2716"});case"pending":return(0,l.jsx)("span",{className:"text-amber-500 text-4xl",children:"\u23f3"});default:return(0,l.jsx)(c.A,{size:"lg"})}};return(0,l.jsx)("div",{className:"max-w-2xl mx-auto px-6 py-16",children:(0,l.jsxs)("div",{className:"bg-white shadow-lg rounded-2xl p-8 text-center space-y-4",children:[(0,l.jsx)("div",{className:"mx-auto w-16 h-16 flex items-center justify-center rounded-full bg-gray-100",children:(0,l.jsx)(v,{})}),(0,l.jsx)("h1",{className:"text-2xl font-semibold text-gray-900",children:"Flutterwave Payment Callback"}),(0,l.jsx)("p",{className:"text-gray-600",children:u}),y&&(0,l.jsx)("p",{className:"text-sm text-gray-500",children:y}),x.txRef&&(0,l.jsxs)("div",{className:"text-xs text-gray-400",children:["Reference: ",x.txRef]}),(0,l.jsx)("div",{className:"pt-4",children:(0,l.jsx)("button",{type:"button",onClick:()=>n(-1),className:"px-4 py-2 text-sm font-medium text-blue-600 hover:underline",children:"Go back"})})]})})}}}]);
//# sourceMappingURL=38.8115b404.chunk.js.map