"use strict";(self.webpackChunkreal_estate_marketplace=self.webpackChunkreal_estate_marketplace||[]).push([[38],{38(e,t,n){n.r(t),n.d(t,{default:()=>m});var a=n(9379),r=n(5043),s=n(5475),o=n(3216),i=n(5016),c=n(1876),l=n(9144),d=n(579);const p="propertyVerificationPayments",m=()=>{const{user:e}=(0,i.As)(),[t]=(0,s.ok)(),n=(0,o.Zp)(),[m,u]=(0,r.useState)("processing"),[f,y]=(0,r.useState)("Processing payment confirmation..."),[w,x]=(0,r.useState)("Hold on while we confirm your payment status."),g=(0,r.useMemo)(()=>({status:t.get("status"),txRef:t.get("tx_ref")||t.get("txRef"),transactionId:t.get("transaction_id")||t.get("transactionId"),processor:t.get("processor")}),[t]);(0,r.useEffect)(()=>{const{txRef:e,status:t}=g;if(!e)return u("error"),y("Missing payment reference"),void x("Unable to determine which payment to verify.");const n=(()=>{if("undefined"===typeof window)return[];try{const e=localStorage.getItem(p);return e?JSON.parse(e):[]}catch(e){return console.warn("PaymentCallback: unable to read stored payments",e),[]}})(),a=n.find(t=>t.txRef===e||t.reference===e);if(!a)return u("error"),y("Payment reference not found"),void x("Please return to the verification form and start the payment again.");v(a,t,n)},[g]);const v=async(t,r,s)=>{const o=(()=>{const t=(null===e||void 0===e?void 0:e.token)||(()=>{try{return localStorage.getItem("token")}catch(e){return null}})(),n=null===e||void 0===e?void 0:e.email;if(!t&&!n)return null;const a={"Content-Type":"application/json"};return t?a.Authorization="Bearer ".concat(t):n&&(a["X-Mock-User-Email"]=n),a})();if(!o)return u("error"),y("Sign in required"),void x("Please log in again to complete verification.");try{var i;u("verifying"),y("Verifying payment..."),x("Hold on while we confirm your payment status.");const e=await fetch((0,c.e9)("/payments/".concat(t.paymentId,"/verify")),{method:"POST",headers:o,body:JSON.stringify({txRef:t.txRef,status:r})}),l=await e.json();if(!e.ok||!l.success)throw new Error(l.message||"Payment verification failed");if("completed"!==(null===(i=l.data)||void 0===i?void 0:i.status))return u("pending"),y("Payment still processing"),void x("We have not received confirmation from Flutterwave yet. Please try again shortly.");(e=>{if("undefined"!==typeof window)try{localStorage.setItem(p,JSON.stringify(e))}catch(t){console.warn("PaymentCallback: unable to write stored payments",t)}})(s.map(e=>e.paymentId===t.paymentId?(0,a.A)((0,a.A)({},e),{},{verified:!0,verificationPaymentId:l.data.id}):e));const d={type:"PROPERTY_VERIFICATION_PAYMENT",payload:{paymentId:t.paymentId,verificationPaymentId:l.data.id,status:"success"}};window.opener&&!window.opener.closed&&window.opener.postMessage(d,"*"),window.parent&&window.parent!==window&&window.parent.postMessage(d,"*"),u("success"),y("Payment verified successfully"),x("You can now return to the verification request modal to finish submission."),setTimeout(()=>{window.close(),t.propertyId&&n("/property/".concat(t.propertyId,"?verification=completed"),{replace:!0})},1500)}catch(l){console.error("PaymentCallback: verification error",l),u("error"),y("Unable to verify payment"),x((null===l||void 0===l?void 0:l.message)||"Please try again from the verification page.");const e={type:"PROPERTY_VERIFICATION_PAYMENT",payload:{paymentId:null===t||void 0===t?void 0:t.paymentId,status:"error",message:(null===l||void 0===l?void 0:l.message)||"Verification failed"}};window.opener&&!window.opener.closed&&window.opener.postMessage(e,"*"),window.parent&&window.parent!==window&&window.parent.postMessage(e,"*")}},h=()=>{switch(m){case"success":return(0,d.jsx)("span",{className:"text-green-600 text-4xl",children:"\u2714"});case"error":return(0,d.jsx)("span",{className:"text-red-500 text-4xl",children:"\u2716"});case"pending":return(0,d.jsx)("span",{className:"text-amber-500 text-4xl",children:"\u23f3"});default:return(0,d.jsx)(l.A,{size:"lg"})}};return(0,d.jsx)("div",{className:"max-w-2xl mx-auto px-6 py-16",children:(0,d.jsxs)("div",{className:"bg-white shadow-lg rounded-2xl p-8 text-center space-y-4",children:[(0,d.jsx)("div",{className:"mx-auto w-16 h-16 flex items-center justify-center rounded-full bg-gray-100",children:(0,d.jsx)(h,{})}),(0,d.jsx)("h1",{className:"text-2xl font-semibold text-gray-900",children:"Flutterwave Payment Callback"}),(0,d.jsx)("p",{className:"text-gray-600",children:f}),w&&(0,d.jsx)("p",{className:"text-sm text-gray-500",children:w}),g.txRef&&(0,d.jsxs)("div",{className:"text-xs text-gray-400",children:["Reference: ",g.txRef]}),(0,d.jsx)("div",{className:"pt-4",children:(0,d.jsx)("button",{type:"button",onClick:()=>n(-1),className:"px-4 py-2 text-sm font-medium text-blue-600 hover:underline",children:"Go back"})})]})})}}}]);
//# sourceMappingURL=38.9194b6fd.chunk.js.map