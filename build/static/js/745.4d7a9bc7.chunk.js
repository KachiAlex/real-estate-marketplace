"use strict";(self.webpackChunkreal_estate_marketplace=self.webpackChunkreal_estate_marketplace||[]).push([[745],{2745(e,t,n){n.r(t),n.d(t,{default:()=>s});var r=n(5043),o=n(5016),i=n(5032),a=n(2339),c=n(579);const s=()=>{const{user:e}=(0,o.As)(),[t,n]=(0,r.useState)([]),[s,d]=(0,r.useState)(!1),[l,u]=(0,r.useState)(!1),[p,m]=(0,r.useState)(null),[y,g]=(0,r.useState)(""),[v,f]=(0,r.useState)(""),b=(0,r.useRef)({}),h=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};try{if(!("Notification"in window))return;"granted"===Notification.permission&&new Notification(e,t)}catch(n){}},w=(e,t)=>{try{return new Date("".concat(e,"T").concat(t,":00"))}catch(n){return null}},x=e=>{const t="Property Inspection - ".concat(e.projectName),n=e.confirmedDate&&e.confirmedTime?w(e.confirmedDate,e.confirmedTime):w(e.preferredDate,e.preferredTime),r=n?new Date(n.getTime()+36e5):null;return{title:t,start:n,end:r,details:"Inspection with ".concat(e.buyerName||"buyer"," at ").concat(e.projectLocation||""),location:e.projectLocation||""}},N=e=>{const t=e=>String(e).padStart(2,"0");return"".concat(e.getUTCFullYear()).concat(t(e.getUTCMonth()+1)).concat(t(e.getUTCDate()),"T").concat(t(e.getUTCHours())).concat(t(e.getUTCMinutes()),"00Z")},I=async()=>{try{d(!0);const t=await(0,i.o2)(null===e||void 0===e?void 0:e.id,null===e||void 0===e?void 0:e.email);n(t)}catch(t){console.error(t)}finally{d(!1)}};(0,r.useEffect)(()=>{if(I(),(null===e||void 0===e||!e.id)&&(null===e||void 0===e||!e.email))return;const t=setInterval(()=>{I()},5e3);return(async()=>{try{const t=await(0,i.o2)(null===e||void 0===e?void 0:e.id,null===e||void 0===e?void 0:e.email);n(t),(async()=>{try{if(!("Notification"in window))return;"default"===Notification.permission&&await Notification.requestPermission()}catch(e){}})();const r=b.current||{};for(const e of t){const t=r[e.id];t&&t!==e.status&&("accepted"===e.status?(a.Ay.success("Inspection accepted for ".concat(e.projectName)),e.confirmedDate&&e.confirmedTime&&h("Inspection accepted",{body:"".concat(e.projectName," on ").concat(e.confirmedDate," ").concat(e.confirmedTime)})):"proposed_new_time"===e.status?(0,a.Ay)("Proposed a new time to buyer",{icon:"\u2713"}):"declined"===e.status&&a.Ay.error("Inspection declined for ".concat(e.projectName)))}b.current=Object.fromEntries(t.map(e=>[e.id,e.status]))}catch(t){console.error("Error loading inspection requests:",t)}})(),()=>clearInterval(t)},[null===e||void 0===e?void 0:e.id,null===e||void 0===e?void 0:e.email]);return(0,c.jsxs)("div",{className:"p-6",children:[(0,c.jsxs)("div",{className:"mb-6",children:[(0,c.jsx)("h1",{className:"text-2xl font-bold text-gray-900",children:"Inspection Requests"}),(0,c.jsx)("p",{className:"text-gray-600",children:"All viewing requests for your listed properties"})]}),(0,c.jsxs)("div",{className:"bg-white rounded-lg shadow",children:[(0,c.jsxs)("div",{className:"p-4 border-b border-gray-200 flex items-center justify-between",children:[(0,c.jsx)("div",{className:"text-sm text-gray-600",children:s?"Loading...":"".concat(t.length," request(s)")}),(0,c.jsx)("button",{onClick:I,className:"btn-outline text-sm",children:"Refresh"})]}),(0,c.jsxs)("div",{className:"divide-y",children:[!s&&0===t.length&&(0,c.jsx)("div",{className:"p-6 text-sm text-gray-600",children:"No inspection requests yet."}),t.map(e=>{var t;return(0,c.jsxs)("div",{className:"p-4 flex items-center text-sm",children:[(0,c.jsxs)("div",{className:"w-1/5",children:[(0,c.jsx)("div",{className:"font-medium text-gray-900",children:e.projectName}),(0,c.jsx)("div",{className:"text-gray-600",children:e.projectLocation})]}),(0,c.jsxs)("div",{className:"w-1/5",children:[(0,c.jsx)("div",{className:"font-medium text-gray-900",children:e.buyerName||"Unknown"}),(0,c.jsx)("div",{className:"text-gray-600",children:e.buyerEmail||""})]}),(0,c.jsxs)("div",{className:"w-1/5",children:[(0,c.jsxs)("div",{children:[e.preferredDate," ",e.preferredTime]}),e.proposedDate&&e.proposedTime&&(0,c.jsxs)("div",{className:"text-xs text-gray-600",children:["Proposed: ",e.proposedDate," ",e.proposedTime]})]}),(0,c.jsx)("div",{className:"w-1/5",children:(0,c.jsx)("span",{className:"px-2 py-1 rounded-full text-xs ".concat("pending_vendor"===e.status?"bg-yellow-100 text-yellow-800":"accepted"===e.status?"bg-green-100 text-green-800":"proposed_new_time"===e.status?"bg-blue-100 text-blue-800":"bg-red-100 text-red-800"),children:(null===(t=e.status)||void 0===t?void 0:t.replaceAll("_"," "))||"pending"})}),(0,c.jsxs)("div",{className:"w-1/5 flex flex-wrap gap-2",children:["accepted"!==e.status&&(0,c.jsx)("button",{onClick:()=>(async e=>{await(0,i.HK)(e.id,{status:"accepted",confirmedDate:e.preferredDate,confirmedTime:e.preferredTime})?(a.Ay.success("Accepted"),I()):a.Ay.error("Failed to accept")})(e),className:"px-3 py-1 bg-green-600 text-white rounded",children:"Accept"}),(0,c.jsx)("button",{onClick:()=>(m(e),g(""),f(""),void u(!0)),className:"px-3 py-1 bg-blue-600 text-white rounded",children:"Propose"}),"declined"!==e.status&&(0,c.jsx)("button",{onClick:()=>(async e=>{await(0,i.HK)(e.id,{status:"declined"})?(a.Ay.success("Declined"),I()):a.Ay.error("Failed to decline")})(e),className:"px-3 py-1 bg-red-600 text-white rounded",children:"Decline"}),"accepted"===e.status&&(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)("button",{onClick:()=>(e=>{const{title:t,start:n,end:r,details:o,location:i}=x(e);if(!n||!r)return void a.Ay.error("Invalid date/time");const c=e=>"".concat(e.getUTCFullYear()).concat(String(e.getUTCMonth()+1).padStart(2,"0")).concat(String(e.getUTCDate()).padStart(2,"0"),"T").concat(String(e.getUTCHours()).padStart(2,"0")).concat(String(e.getUTCMinutes()).padStart(2,"0"),"00Z"),s=encodeURIComponent(t),d="".concat(c(n),"/").concat(c(r)),l=encodeURIComponent(o),u=encodeURIComponent(i),p="https://www.google.com/calendar/render?action=TEMPLATE&text=".concat(s,"&dates=").concat(d,"&details=").concat(l,"&location=").concat(u);window.open(p,"_blank")})(e),className:"px-3 py-1 bg-gray-800 text-white rounded",children:"Google Calendar"}),(0,c.jsx)("button",{onClick:()=>(e=>{const{title:t,start:n,end:r,details:o,location:i}=x(e);if(!n||!r)return void a.Ay.error("Invalid date/time");const c=["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//PropertyArk//Inspection//EN","BEGIN:VEVENT","UID:".concat(e.id,"@propertyark"),"DTSTAMP:".concat(N(new Date)),"DTSTART:".concat(N(n)),"DTEND:".concat(N(r)),"SUMMARY:".concat(t),"DESCRIPTION:".concat(o),"LOCATION:".concat(i),"END:VEVENT","END:VCALENDAR"].join("\r\n"),s=new Blob([c],{type:"text/calendar;charset=utf-8"}),d=URL.createObjectURL(s),l=document.createElement("a");l.href=d,l.download="inspection-".concat(e.id,".ics"),document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(d)})(e),className:"px-3 py-1 border rounded",children:"Download .ics"})]})]})]},e.id)})]})]}),l&&p&&(0,c.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:(0,c.jsxs)("div",{className:"bg-white rounded-lg max-w-md w-full p-6",children:[(0,c.jsxs)("div",{className:"flex items-start justify-between mb-4",children:[(0,c.jsx)("h3",{className:"text-lg font-bold text-gray-900",children:"Propose New Time"}),(0,c.jsx)("button",{onClick:()=>u(!1),className:"text-gray-500 hover:text-gray-700",children:"\xd7"})]}),(0,c.jsxs)("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4 text-sm",children:[(0,c.jsx)("p",{className:"font-semibold",children:p.projectName}),(0,c.jsxs)("p",{className:"text-gray-600",children:["Buyer: ",p.buyerName||"Unknown"]}),(0,c.jsxs)("p",{className:"text-gray-600",children:["Preferred: ",p.preferredDate," ",p.preferredTime]})]}),(0,c.jsxs)("div",{className:"grid grid-cols-1 gap-4",children:[(0,c.jsxs)("div",{children:[(0,c.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"New date"}),(0,c.jsx)("input",{type:"date",value:y,onChange:e=>g(e.target.value),className:"w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500"})]}),(0,c.jsxs)("div",{children:[(0,c.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"New time"}),(0,c.jsx)("input",{type:"time",value:v,onChange:e=>f(e.target.value),className:"w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500"})]})]}),(0,c.jsxs)("div",{className:"flex justify-between mt-6",children:[(0,c.jsx)("button",{onClick:()=>u(!1),className:"px-5 py-2 border rounded-lg",children:"Cancel"}),(0,c.jsx)("button",{onClick:async()=>{if(!y||!v||!p)return void a.Ay.error("Provide date and time");await(0,i.HK)(p.id,{status:"proposed_new_time",proposedDate:y,proposedTime:v})?(a.Ay.success("Proposed new time"),u(!1),m(null),I()):a.Ay.error("Failed to propose")},disabled:!y||!v,className:"px-5 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50",children:"Send Proposal"})]})]})})]})}},5032(e,t,n){n.d(t,{FH:()=>v,HK:()=>h,Ix:()=>f,o2:()=>b});var r=n(9379),o=n(1692);const i="viewingRequests",a="inspectionActivityLog",c={totalRequests:0,pendingResponses:0,confirmed:0,vendorProposals:0,buyerReschedules:0,cancelledByBuyer:0,cancelledByVendor:0,timeline:[]},s=(e,t)=>{if("undefined"!==typeof window)if("storage"!==e)"function"===typeof window.dispatchEvent&&window.dispatchEvent(new CustomEvent(e,{detail:t}));else try{window.dispatchEvent(new StorageEvent("storage",t))}catch(n){window.dispatchEvent(new CustomEvent("storage",{detail:t}))}},d=()=>{try{return JSON.parse(localStorage.getItem(i)||"[]")}catch(e){return[]}},l=e=>{localStorage.setItem(i,JSON.stringify(e))},u=()=>{try{return JSON.parse(localStorage.getItem(a)||"[]")}catch(e){return[]}},p=(e,t)=>e||t?t?e?"".concat(e," ").concat(t):t:e:"",m=(e,t)=>{if(!e||!t)return;const n=((e,t)=>({action:e,requestId:t.id,propertyTitle:t.propertyTitle||t.projectTitle||t.projectName||t.title||"Property",buyerId:t.buyerId||t.userId,vendorId:t.vendorId,vendorEmail:t.vendorEmail,status:t.status,timestamp:(new Date).toISOString()}))(e,t),i=u();i.unshift(n),i.length>200&&i.pop(),(e=>{localStorage.setItem(a,JSON.stringify(e))})(i),s("inspectionActivity",n),s("inspectionAnalyticsUpdated",n);const c=((e,t,n)=>{const r=[],o=n.propertyTitle,i=t.buyerName||t.userName||"Buyer",a=t.vendorName||t.vendor||t.owner||"Vendor",c=p(t.preferredDate,t.preferredTime),s=p(t.confirmedDate,t.confirmedTime),d=p(t.proposedDate,t.proposedTime),l=(n,c)=>{(t.vendorId||t.vendorEmail)&&r.push({recipientId:t.vendorId,recipientEmail:t.vendorEmail,roles:["vendor"],type:e,title:n,message:c,priority:"medium",metadata:{requestId:t.id,propertyTitle:o,buyerName:i,vendorName:a}})},u=(n,c)=>{(t.buyerId||t.userId||t.buyerEmail||t.userEmail)&&r.push({recipientId:t.buyerId||t.userId,recipientEmail:t.buyerEmail||t.userEmail,roles:["buyer"],type:e,title:n,message:c,priority:"medium",metadata:{requestId:t.id,propertyTitle:o,buyerName:i,vendorName:a}})};switch(e){case"inspection_requested":l("New inspection request","".concat(i," requested to view ").concat(o," ").concat(c?"on ".concat(c):"").trim());break;case"inspection_confirmed":u("Inspection confirmed","".concat(a," confirmed ").concat(o," ").concat(s?"for ".concat(s):"").trim());break;case"vendor_proposed_new_time":u("Vendor proposed new time","".concat(a," suggested ").concat(d||"another slot"," for ").concat(o));break;case"buyer_rescheduled":l("Buyer requested new time","".concat(i," rescheduled ").concat(o," ").concat(c?"to ".concat(c):"").trim());break;case"inspection_cancelled_by_buyer":l("Inspection cancelled by buyer","".concat(i," cancelled ").concat(o));break;case"inspection_cancelled_by_vendor":u("Inspection cancelled by vendor","".concat(a," cancelled ").concat(o));break;case"inspection_declined":u("Inspection declined","".concat(a," declined the request for ").concat(o))}return r})(e,t,n);c.length&&(s("inspectionNotification",{action:e,payload:n,notifications:c,request:t}),function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];if(!e.length||"undefined"===typeof window)return;const t=e.filter(e=>e.recipientId).map(e=>{var t;return{recipientId:e.recipientId,type:e.type,title:e.title,message:e.message,priority:e.priority||"medium",metadata:(0,r.A)((0,r.A)({},e.metadata||{}),{},{source:(null===(t=e.metadata)||void 0===t?void 0:t.source)||"inspection_client_sync"}),data:e.metadata||{}}});t.length&&o.A.createInspectionNotifications(t).then(e=>{null!==e&&void 0!==e&&e.success||console.warn("Failed to persist inspection notifications",e)}).catch(e=>{console.error("Error persisting inspection notifications:",e)})}(c))},y=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const r=((null===t||void 0===t?void 0:t.status)||n.status||"").toLowerCase();if(!r&&(n.proposedDate||n.proposedTime))return"vendor_proposed_new_time";switch(r){case"accepted":case"confirmed":return"inspection_confirmed";case"proposed_new_time":return"vendor_proposed_new_time";case"buyer_rescheduled":return"buyer_rescheduled";case"cancelled_by_buyer":return"inspection_cancelled_by_buyer";case"cancelled_by_vendor":return"inspection_cancelled_by_vendor";case"declined":return"inspection_declined";default:return e&&e.status!==(null===t||void 0===t?void 0:t.status)?"inspection_status_".concat((null===t||void 0===t?void 0:t.status)||"updated"):null}},g=(e,t,n)=>!(!t&&!n)&&(t&&(null===e||void 0===e?void 0:e.vendorId)===t||n&&(null===e||void 0===e?void 0:e.vendorEmail)===n),v=function(){let{role:e="buyer",userId:t,vendorId:n,vendorEmail:o}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if("undefined"===typeof window)return(0,r.A)({},c);if("buyer"===e&&!t)return(0,r.A)({},c);if("vendor"===e&&!n&&!o)return(0,r.A)({},c);const i=d().filter(r=>{return"buyer"===e?(i=r,!!(a=t)&&((null===i||void 0===i?void 0:i.buyerId)===a||(null===i||void 0===i?void 0:i.userId)===a)):g(r,n||r.vendorId,o);var i,a}),a={totalRequests:i.length,pendingResponses:0,confirmed:0,vendorProposals:0,buyerReschedules:0,cancelledByBuyer:0,cancelledByVendor:0,timeline:[]},s=["pending","pending_vendor","pending_vendor_confirmation"],l=u();i.forEach(e=>{const t=(e.status||"").toLowerCase();s.includes(t)&&(a.pendingResponses+=1),["accepted","confirmed"].includes(t)&&(a.confirmed+=1),"proposed_new_time"===t&&(a.vendorProposals+=1),"buyer_rescheduled"===t&&(a.buyerReschedules+=1),"cancelled_by_buyer"===t&&(a.cancelledByBuyer+=1),["cancelled_by_vendor","declined"].includes(t)&&(a.cancelledByVendor+=1)});const p=Array.from({length:7}).map((r,i)=>{const a=new Date;a.setDate(a.getDate()-(6-i));const c=a.toISOString().slice(0,10),s=l.filter(r=>{return(r=>"buyer"===e?(null===r||void 0===r?void 0:r.buyerId)===t:g(r,n,o))(r)&&((i=r.timestamp)?new Date(i):new Date).toISOString().slice(0,10)===c;var i}).length;return{date:c,count:s}});return a.timeline=p,a},f=async e=>{try{console.log("Using localStorage for creating inspection requests (API unavailable)");const t=d(),n=(0,r.A)((0,r.A)({id:"viewing-".concat(Date.now())},e),{},{createdAt:(new Date).toISOString(),status:"pending"});return t.push(n),l(t),s("viewingsUpdated",{viewingRequest:n,action:"created"}),s("storage",{key:i,newValue:JSON.stringify(t)}),m("inspection_requested",n),n}catch(t){console.error("Error creating inspection request:",t);const n=d(),o=(0,r.A)((0,r.A)({id:"viewing-".concat(Date.now())},e),{},{createdAt:(new Date).toISOString(),status:"pending"});return n.push(o),l(n),s("viewingsUpdated",{viewingRequest:o,action:"created"}),s("storage",{key:i,newValue:JSON.stringify(n)}),m("inspection_requested",o),o}},b=async(e,t)=>{try{console.log("Using localStorage for inspection requests (API unavailable)");const n=d().filter(n=>e&&n.vendorId===e||t&&n.vendorEmail===t);return n.sort((e,t)=>new Date(t.createdAt||0)-new Date(e.createdAt||0)),n}catch(n){console.error("Error listing inspection requests:",n);return d().filter(n=>e&&n.vendorId===e||t&&n.vendorEmail===t).sort((e,t)=>new Date(t.createdAt||0)-new Date(e.createdAt||0))}},h=async(e,t)=>{try{console.log("Using localStorage for updating inspection requests (API unavailable)");const n=d();let o=null;const a=n.map(n=>n.id===e?(o=(0,r.A)((0,r.A)((0,r.A)({},n),t),{},{updatedAt:(new Date).toISOString()}),o):n);if(!o)return l(n),!1;l(a),s("viewingsUpdated",{requestId:e,updates:t,action:"updated"}),s("storage",{key:i,newValue:JSON.stringify(a)});const c=y(n.find(t=>t.id===e),o,t);return c&&m(c,o),!0}catch(n){console.error("Error updating inspection request:",n);const o=d();let a=null;const c=o.map(n=>n.id===e?(a=(0,r.A)((0,r.A)((0,r.A)({},n),t),{},{updatedAt:(new Date).toISOString()}),a):n);if(!a)return l(o),!1;l(c),s("viewingsUpdated",{requestId:e,updates:t,action:"updated"}),s("storage",{key:i,newValue:JSON.stringify(c)});const u=y(o.find(t=>t.id===e),a,t);return u&&m(u,a),!0}}}}]);
//# sourceMappingURL=745.4d7a9bc7.chunk.js.map