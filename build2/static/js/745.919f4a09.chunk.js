"use strict";(self.webpackChunkreal_estate_marketplace=self.webpackChunkreal_estate_marketplace||[]).push([[745],{2745:(e,t,n)=>{n.r(t),n.d(t,{default:()=>d});var r=n(5043),i=n(5016),s=n(5032),o=n(3768),a=n(579);const d=()=>{const{user:e}=(0,i.As)(),[t,n]=(0,r.useState)([]),[d,c]=(0,r.useState)(!1),[l,u]=(0,r.useState)(!1),[p,m]=(0,r.useState)(null),[y,g]=(0,r.useState)(""),[v,f]=(0,r.useState)(""),b=(0,r.useRef)({}),h=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};try{if(!("Notification"in window))return;"granted"===Notification.permission&&new Notification(e,t)}catch(n){}},w=(e,t)=>{try{return new Date(`${e}T${t}:00`)}catch{return null}},x=e=>{const t=`Property Inspection - ${e.projectName}`,n=e.confirmedDate&&e.confirmedTime?w(e.confirmedDate,e.confirmedTime):w(e.preferredDate,e.preferredTime),r=n?new Date(n.getTime()+36e5):null;return{title:t,start:n,end:r,details:`Inspection with ${e.buyerName||"buyer"} at ${e.projectLocation||""}`,location:e.projectLocation||""}},N=e=>{const t=e=>String(e).padStart(2,"0");return`${e.getUTCFullYear()}${t(e.getUTCMonth()+1)}${t(e.getUTCDate())}T${t(e.getUTCHours())}${t(e.getUTCMinutes())}00Z`},I=async()=>{try{c(!0);const t=await(0,s.o2)(null===e||void 0===e?void 0:e.id,null===e||void 0===e?void 0:e.email);n(t)}catch(t){console.error(t)}finally{c(!1)}};(0,r.useEffect)(()=>{if(I(),(null===e||void 0===e||!e.id)&&(null===e||void 0===e||!e.email))return;const t=setInterval(()=>{I()},5e3);return(async()=>{try{const t=await(0,s.o2)(null===e||void 0===e?void 0:e.id,null===e||void 0===e?void 0:e.email);n(t),(async()=>{try{if(!("Notification"in window))return;"default"===Notification.permission&&await Notification.requestPermission()}catch(e){}})();const r=b.current||{};for(const e of t){const t=r[e.id];t&&t!==e.status&&("accepted"===e.status?(o.Ay.success(`Inspection accepted for ${e.projectName}`),e.confirmedDate&&e.confirmedTime&&h("Inspection accepted",{body:`${e.projectName} on ${e.confirmedDate} ${e.confirmedTime}`})):"proposed_new_time"===e.status?(0,o.Ay)("Proposed a new time to buyer",{icon:"\u2713"}):"declined"===e.status&&o.Ay.error(`Inspection declined for ${e.projectName}`))}b.current=Object.fromEntries(t.map(e=>[e.id,e.status]))}catch(t){console.error("Error loading inspection requests:",t)}})(),()=>clearInterval(t)},[null===e||void 0===e?void 0:e.id,null===e||void 0===e?void 0:e.email]);return(0,a.jsxs)("div",{className:"p-6",children:[(0,a.jsxs)("div",{className:"mb-6",children:[(0,a.jsx)("h1",{className:"text-2xl font-bold text-gray-900",children:"Inspection Requests"}),(0,a.jsx)("p",{className:"text-gray-600",children:"All viewing requests for your listed properties"})]}),(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow",children:[(0,a.jsxs)("div",{className:"p-4 border-b border-gray-200 flex items-center justify-between",children:[(0,a.jsx)("div",{className:"text-sm text-gray-600",children:d?"Loading...":`${t.length} request(s)`}),(0,a.jsx)("button",{onClick:I,className:"btn-outline text-sm",children:"Refresh"})]}),(0,a.jsxs)("div",{className:"divide-y",children:[!d&&0===t.length&&(0,a.jsx)("div",{className:"p-6 text-sm text-gray-600",children:"No inspection requests yet."}),t.map(e=>{var t;return(0,a.jsxs)("div",{className:"p-4 flex items-center text-sm",children:[(0,a.jsxs)("div",{className:"w-1/5",children:[(0,a.jsx)("div",{className:"font-medium text-gray-900",children:e.projectName}),(0,a.jsx)("div",{className:"text-gray-600",children:e.projectLocation})]}),(0,a.jsxs)("div",{className:"w-1/5",children:[(0,a.jsx)("div",{className:"font-medium text-gray-900",children:e.buyerName||"Unknown"}),(0,a.jsx)("div",{className:"text-gray-600",children:e.buyerEmail||""})]}),(0,a.jsxs)("div",{className:"w-1/5",children:[(0,a.jsxs)("div",{children:[e.preferredDate," ",e.preferredTime]}),e.proposedDate&&e.proposedTime&&(0,a.jsxs)("div",{className:"text-xs text-gray-600",children:["Proposed: ",e.proposedDate," ",e.proposedTime]})]}),(0,a.jsx)("div",{className:"w-1/5",children:(0,a.jsx)("span",{className:"px-2 py-1 rounded-full text-xs "+("pending_vendor"===e.status?"bg-yellow-100 text-yellow-800":"accepted"===e.status?"bg-green-100 text-green-800":"proposed_new_time"===e.status?"bg-blue-100 text-blue-800":"bg-red-100 text-red-800"),children:(null===(t=e.status)||void 0===t?void 0:t.replaceAll("_"," "))||"pending"})}),(0,a.jsxs)("div",{className:"w-1/5 flex flex-wrap gap-2",children:["accepted"!==e.status&&(0,a.jsx)("button",{onClick:()=>(async e=>{await(0,s.HK)(e.id,{status:"accepted",confirmedDate:e.preferredDate,confirmedTime:e.preferredTime})?(o.Ay.success("Accepted"),I()):o.Ay.error("Failed to accept")})(e),className:"px-3 py-1 bg-green-600 text-white rounded",children:"Accept"}),(0,a.jsx)("button",{onClick:()=>(m(e),g(""),f(""),void u(!0)),className:"px-3 py-1 bg-blue-600 text-white rounded",children:"Propose"}),"declined"!==e.status&&(0,a.jsx)("button",{onClick:()=>(async e=>{await(0,s.HK)(e.id,{status:"declined"})?(o.Ay.success("Declined"),I()):o.Ay.error("Failed to decline")})(e),className:"px-3 py-1 bg-red-600 text-white rounded",children:"Decline"}),"accepted"===e.status&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("button",{onClick:()=>(e=>{const{title:t,start:n,end:r,details:i,location:s}=x(e);if(!n||!r)return void o.Ay.error("Invalid date/time");const a=e=>`${e.getUTCFullYear()}${String(e.getUTCMonth()+1).padStart(2,"0")}${String(e.getUTCDate()).padStart(2,"0")}T${String(e.getUTCHours()).padStart(2,"0")}${String(e.getUTCMinutes()).padStart(2,"0")}00Z`,d=`https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(t)}&dates=${a(n)}/${a(r)}&details=${encodeURIComponent(i)}&location=${encodeURIComponent(s)}`;window.open(d,"_blank")})(e),className:"px-3 py-1 bg-gray-800 text-white rounded",children:"Google Calendar"}),(0,a.jsx)("button",{onClick:()=>(e=>{const{title:t,start:n,end:r,details:i,location:s}=x(e);if(!n||!r)return void o.Ay.error("Invalid date/time");const a=["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//PropertyArk//Inspection//EN","BEGIN:VEVENT",`UID:${e.id}@propertyark`,`DTSTAMP:${N(new Date)}`,`DTSTART:${N(n)}`,`DTEND:${N(r)}`,`SUMMARY:${t}`,`DESCRIPTION:${i}`,`LOCATION:${s}`,"END:VEVENT","END:VCALENDAR"].join("\r\n"),d=new Blob([a],{type:"text/calendar;charset=utf-8"}),c=URL.createObjectURL(d),l=document.createElement("a");l.href=c,l.download=`inspection-${e.id}.ics`,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(c)})(e),className:"px-3 py-1 border rounded",children:"Download .ics"})]})]})]},e.id)})]})]}),l&&p&&(0,a.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:(0,a.jsxs)("div",{className:"bg-white rounded-lg max-w-md w-full p-6",children:[(0,a.jsxs)("div",{className:"flex items-start justify-between mb-4",children:[(0,a.jsx)("h3",{className:"text-lg font-bold text-gray-900",children:"Propose New Time"}),(0,a.jsx)("button",{onClick:()=>u(!1),className:"text-gray-500 hover:text-gray-700",children:"\xd7"})]}),(0,a.jsxs)("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4 text-sm",children:[(0,a.jsx)("p",{className:"font-semibold",children:p.projectName}),(0,a.jsxs)("p",{className:"text-gray-600",children:["Buyer: ",p.buyerName||"Unknown"]}),(0,a.jsxs)("p",{className:"text-gray-600",children:["Preferred: ",p.preferredDate," ",p.preferredTime]})]}),(0,a.jsxs)("div",{className:"grid grid-cols-1 gap-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"New date"}),(0,a.jsx)("input",{type:"date",value:y,onChange:e=>g(e.target.value),className:"w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"New time"}),(0,a.jsx)("input",{type:"time",value:v,onChange:e=>f(e.target.value),className:"w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500"})]})]}),(0,a.jsxs)("div",{className:"flex justify-between mt-6",children:[(0,a.jsx)("button",{onClick:()=>u(!1),className:"px-5 py-2 border rounded-lg",children:"Cancel"}),(0,a.jsx)("button",{onClick:async()=>{if(!y||!v||!p)return void o.Ay.error("Provide date and time");await(0,s.HK)(p.id,{status:"proposed_new_time",proposedDate:y,proposedTime:v})?(o.Ay.success("Proposed new time"),u(!1),m(null),I()):o.Ay.error("Failed to propose")},disabled:!y||!v,className:"px-5 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50",children:"Send Proposal"})]})]})})]})}},5032:(e,t,n)=>{n.d(t,{FH:()=>g,HK:()=>b,Ix:()=>v,o2:()=>f});var r=n(1692);const i="viewingRequests",s="inspectionActivityLog",o={totalRequests:0,pendingResponses:0,confirmed:0,vendorProposals:0,buyerReschedules:0,cancelledByBuyer:0,cancelledByVendor:0,timeline:[]},a=(e,t)=>{if("undefined"!==typeof window)if("storage"!==e)"function"===typeof window.dispatchEvent&&window.dispatchEvent(new CustomEvent(e,{detail:t}));else try{window.dispatchEvent(new StorageEvent("storage",t))}catch{window.dispatchEvent(new CustomEvent("storage",{detail:t}))}},d=()=>{try{return JSON.parse(localStorage.getItem(i)||"[]")}catch{return[]}},c=e=>{localStorage.setItem(i,JSON.stringify(e))},l=()=>{try{return JSON.parse(localStorage.getItem(s)||"[]")}catch{return[]}},u=(e,t)=>e||t?t?e?`${e} ${t}`:t:e:"",p=(e,t)=>{if(!e||!t)return;const n=((e,t)=>({action:e,requestId:t.id,propertyTitle:t.propertyTitle||t.projectTitle||t.projectName||t.title||"Property",buyerId:t.buyerId||t.userId,vendorId:t.vendorId,vendorEmail:t.vendorEmail,status:t.status,timestamp:(new Date).toISOString()}))(e,t),i=l();i.unshift(n),i.length>200&&i.pop(),(e=>{localStorage.setItem(s,JSON.stringify(e))})(i),a("inspectionActivity",n),a("inspectionAnalyticsUpdated",n);const o=((e,t,n)=>{const r=[],i=n.propertyTitle,s=t.buyerName||t.userName||"Buyer",o=t.vendorName||t.vendor||t.owner||"Vendor",a=u(t.preferredDate,t.preferredTime),d=u(t.confirmedDate,t.confirmedTime),c=u(t.proposedDate,t.proposedTime),l=(n,a)=>{(t.vendorId||t.vendorEmail)&&r.push({recipientId:t.vendorId,recipientEmail:t.vendorEmail,roles:["vendor"],type:e,title:n,message:a,priority:"medium",metadata:{requestId:t.id,propertyTitle:i,buyerName:s,vendorName:o}})},p=(n,a)=>{(t.buyerId||t.userId||t.buyerEmail||t.userEmail)&&r.push({recipientId:t.buyerId||t.userId,recipientEmail:t.buyerEmail||t.userEmail,roles:["buyer"],type:e,title:n,message:a,priority:"medium",metadata:{requestId:t.id,propertyTitle:i,buyerName:s,vendorName:o}})};switch(e){case"inspection_requested":l("New inspection request",`${s} requested to view ${i} ${a?`on ${a}`:""}`.trim());break;case"inspection_confirmed":p("Inspection confirmed",`${o} confirmed ${i} ${d?`for ${d}`:""}`.trim());break;case"vendor_proposed_new_time":p("Vendor proposed new time",`${o} suggested ${c||"another slot"} for ${i}`);break;case"buyer_rescheduled":l("Buyer requested new time",`${s} rescheduled ${i} ${a?`to ${a}`:""}`.trim());break;case"inspection_cancelled_by_buyer":l("Inspection cancelled by buyer",`${s} cancelled ${i}`);break;case"inspection_cancelled_by_vendor":p("Inspection cancelled by vendor",`${o} cancelled ${i}`);break;case"inspection_declined":p("Inspection declined",`${o} declined the request for ${i}`)}return r})(e,t,n);o.length&&(a("inspectionNotification",{action:e,payload:n,notifications:o,request:t}),function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];if(!e.length||"undefined"===typeof window)return;const t=e.filter(e=>e.recipientId).map(e=>{var t;return{recipientId:e.recipientId,type:e.type,title:e.title,message:e.message,priority:e.priority||"medium",metadata:{...e.metadata||{},source:(null===(t=e.metadata)||void 0===t?void 0:t.source)||"inspection_client_sync"},data:e.metadata||{}}});t.length&&r.A.createInspectionNotifications(t).then(e=>{null!==e&&void 0!==e&&e.success||console.warn("Failed to persist inspection notifications",e)}).catch(e=>{console.error("Error persisting inspection notifications:",e)})}(o))},m=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const r=((null===t||void 0===t?void 0:t.status)||n.status||"").toLowerCase();if(!r&&(n.proposedDate||n.proposedTime))return"vendor_proposed_new_time";switch(r){case"accepted":case"confirmed":return"inspection_confirmed";case"proposed_new_time":return"vendor_proposed_new_time";case"buyer_rescheduled":return"buyer_rescheduled";case"cancelled_by_buyer":return"inspection_cancelled_by_buyer";case"cancelled_by_vendor":return"inspection_cancelled_by_vendor";case"declined":return"inspection_declined";default:return e&&e.status!==(null===t||void 0===t?void 0:t.status)?`inspection_status_${(null===t||void 0===t?void 0:t.status)||"updated"}`:null}},y=(e,t,n)=>!(!t&&!n)&&(t&&(null===e||void 0===e?void 0:e.vendorId)===t||n&&(null===e||void 0===e?void 0:e.vendorEmail)===n),g=function(){let{role:e="buyer",userId:t,vendorId:n,vendorEmail:r}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if("undefined"===typeof window)return{...o};if("buyer"===e&&!t)return{...o};if("vendor"===e&&!n&&!r)return{...o};const i=d().filter(i=>{return"buyer"===e?(s=i,!!(o=t)&&((null===s||void 0===s?void 0:s.buyerId)===o||(null===s||void 0===s?void 0:s.userId)===o)):y(i,n||i.vendorId,r);var s,o}),s={totalRequests:i.length,pendingResponses:0,confirmed:0,vendorProposals:0,buyerReschedules:0,cancelledByBuyer:0,cancelledByVendor:0,timeline:[]},a=["pending","pending_vendor","pending_vendor_confirmation"],c=l();i.forEach(e=>{const t=(e.status||"").toLowerCase();a.includes(t)&&(s.pendingResponses+=1),["accepted","confirmed"].includes(t)&&(s.confirmed+=1),"proposed_new_time"===t&&(s.vendorProposals+=1),"buyer_rescheduled"===t&&(s.buyerReschedules+=1),"cancelled_by_buyer"===t&&(s.cancelledByBuyer+=1),["cancelled_by_vendor","declined"].includes(t)&&(s.cancelledByVendor+=1)});const u=Array.from({length:7}).map((i,s)=>{const o=new Date;o.setDate(o.getDate()-(6-s));const a=o.toISOString().slice(0,10),d=c.filter(i=>{return(i=>"buyer"===e?(null===i||void 0===i?void 0:i.buyerId)===t:y(i,n,r))(i)&&((s=i.timestamp)?new Date(s):new Date).toISOString().slice(0,10)===a;var s}).length;return{date:a,count:d}});return s.timeline=u,s},v=async e=>{try{console.log("Using localStorage for creating inspection requests (API unavailable)");const t=d(),n={id:`viewing-${Date.now()}`,...e,createdAt:(new Date).toISOString(),status:"pending"};return t.push(n),c(t),a("viewingsUpdated",{viewingRequest:n,action:"created"}),a("storage",{key:i,newValue:JSON.stringify(t)}),p("inspection_requested",n),n}catch(t){console.error("Error creating inspection request:",t);const n=d(),r={id:`viewing-${Date.now()}`,...e,createdAt:(new Date).toISOString(),status:"pending"};return n.push(r),c(n),a("viewingsUpdated",{viewingRequest:r,action:"created"}),a("storage",{key:i,newValue:JSON.stringify(n)}),p("inspection_requested",r),r}},f=async(e,t)=>{try{console.log("Using localStorage for inspection requests (API unavailable)");const n=d().filter(n=>e&&n.vendorId===e||t&&n.vendorEmail===t);return n.sort((e,t)=>new Date(t.createdAt||0)-new Date(e.createdAt||0)),n}catch(n){console.error("Error listing inspection requests:",n);return d().filter(n=>e&&n.vendorId===e||t&&n.vendorEmail===t).sort((e,t)=>new Date(t.createdAt||0)-new Date(e.createdAt||0))}},b=async(e,t)=>{try{console.log("Using localStorage for updating inspection requests (API unavailable)");const n=d();let r=null;const s=n.map(n=>n.id===e?(r={...n,...t,updatedAt:(new Date).toISOString()},r):n);if(!r)return c(n),!1;c(s),a("viewingsUpdated",{requestId:e,updates:t,action:"updated"}),a("storage",{key:i,newValue:JSON.stringify(s)});const o=m(n.find(t=>t.id===e),r,t);return o&&p(o,r),!0}catch(n){console.error("Error updating inspection request:",n);const r=d();let s=null;const o=r.map(n=>n.id===e?(s={...n,...t,updatedAt:(new Date).toISOString()},s):n);if(!s)return c(r),!1;c(o),a("viewingsUpdated",{requestId:e,updates:t,action:"updated"}),a("storage",{key:i,newValue:JSON.stringify(o)});const l=m(r.find(t=>t.id===e),s,t);return l&&p(l,s),!0}}}}]);
//# sourceMappingURL=745.919f4a09.chunk.js.map